<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게임 참여하기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style> body { font-family: 'Gowun Dodum', sans-serif; background-color: #f0f9ff; } </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-xl text-center">
        <h1 class="text-3xl font-bold text-sky-700 mb-6">게임 참여</h1>
        <form id="join-form">
            <input type="text" id="player-name" placeholder="이름을 입력하세요" class="w-full p-3 border rounded-md text-center text-lg mb-4" required>
            <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 rounded-full text-xl transition">참여하기</button>
        </form>
        <div id="loading" class="hidden">
            <p class="text-lg text-gray-600">게임 시작을 기다리는 중...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===============================================================
        // 여기에 복사해 둔 Firebase 설정 코드를 붙여넣으세요.
       const firebaseConfig = {
    apiKey: "AIzaSyBCNjgy_28rzMu66Si9W4U6y6sZ6kffIPk",
    authDomain: "verse-game.firebaseapp.com",
    projectId: "verse-game",
    storageBucket: "verse-game.firebasestorage.app",
    messagingSenderId: "84261757024",
    appId: "1:84261757024:web:9f59c6bf44ab0ebb982305"
  };
        // ===============================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const joinForm = document.getElementById('join-form');
        const playerNameInput = document.getElementById('player-name');
        const loadingDiv = document.getElementById('loading');

        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('gameId');

        if (!gameId) {
            alert("잘못된 접근입니다. QR 코드를 다시 스캔해주세요.");
            window.location.href = "/";
        }

        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert("이름을 입력해주세요.");
                return;
            }

            try {
                // players 서브컬렉션에 새로운 플레이어 추가
                const playersRef = collection(db, "games", gameId, "players");
                const playerDocRef = await addDoc(playersRef, {
                    name: playerName,
                    score: 0
                });

                // 게임 시작을 감지하는 리스너 설정
                const gameRef = doc(db, "games", gameId);
                onSnapshot(gameRef, (doc) => {
                    const gameData = doc.data();
                    if (gameData.state === "playing") {
                        // 게임이 시작되면 controller.html로 이동
                        window.location.href = `controller.html?gameId=${gameId}&playerId=${playerDocRef.id}`;
                    }
                });

                joinForm.classList.add('hidden');
                loadingDiv.classList.remove('hidden');

            } catch (error) {
                console.error("참여 오류:", error);
                alert("게임 참여에 실패했습니다. 다시 시도해주세요.");
            }
        });
    </script>
</body>
</html>