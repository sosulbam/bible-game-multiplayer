<!-- ======================================================================= -->
<!-- =======================   index.html (ì§„í–‰ì í™”ë©´)   ======================= -->
<!-- ======================================================================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ì”€ì˜ ë¹›: ê·¸ë£¹ ëŒ€ì „ (ì§„í–‰ì í™”ë©´)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Gowun Dodum', sans-serif; background-color: #f0f9ff; }
        canvas { background: linear-gradient(to bottom, #38bdf8, #e0f2fe); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .category-btn.selected { background-color: #0ea5e9; color: white; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="game-container" class="w-full max-w-5xl mx-auto p-4 text-center">
        <!-- ëŒ€ê¸° í™”ë©´ -->
        <div id="lobby-screen">
            <h1 class="text-4xl font-bold text-sky-700 mb-4">ë§ì”€ì˜ ë¹›: ê·¸ë£¹ ëŒ€ì „</h1>
            <p class="text-xl text-gray-600 mb-6">ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ê²Œì„ì— ì°¸ì—¬í•˜ì„¸ìš”!</p>
            
            <div class="max-w-3xl mx-auto bg-white/70 p-4 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-bold text-gray-700 mb-3">ê²Œì„ ì„¤ì •</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div>
                        <label class="font-bold">ì¹´í…Œê³ ë¦¬ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥):</label>
                        <div id="category-selector" class="mt-2 flex flex-wrap gap-2 p-2 bg-gray-100 rounded-md max-h-48 overflow-y-auto">
                            <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label for="rounds-input" class="font-bold">ë¬¸ì œ ìˆ˜:</label>
                            <input type="number" id="rounds-input" value="10" min="5" max="50" step="1" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="time-limit-input" class="font-bold">ì´ ê²Œì„ ì‹œê°„ (ë¶„):</label>
                            <input type="number" id="time-limit-input" value="3" min="1" max="10" step="1" class="w-full p-2 border rounded-md">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center gap-8">
                <div id="qrcode" class="p-4 bg-white rounded-lg shadow-md"></div>
                <div>
                    <h2 class="text-2xl font-bold mb-3">ì°¸ê°€ì ëª©ë¡ (<span id="player-count">0</span>ëª…)</h2>
                    <ul id="player-list" class="text-left text-lg space-y-2 h-48 overflow-y-auto p-2 bg-gray-100 rounded-lg">
                        <li class="text-gray-500">ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤...</li>
                    </ul>
                </div>
            </div>
            <div class="mt-8">
                <button id="start-game-button" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>ê²Œì„ ì‹œì‘</button>
            </div>
            <div class="mt-4 space-y-2">
                 <p class="text-gray-500">ê²Œì„ ID: <span id="game-id-display"></span></p>
                 <div id="pc-join-url-container" class="mt-2 hidden">
                    <p class="text-gray-600">PC ì°¸ê°€ììš© ì£¼ì†Œ:</p>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <input type="text" id="pc-join-url" class="w-full max-w-md p-2 border rounded-md bg-gray-100 text-center" readonly>
                        <button id="copy-url-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md transition">ë³µì‚¬</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²Œì„ í™”ë©´ -->
        <div id="game-screen" class="hidden">
            <div id="game-ui" class="mb-2 p-3 bg-white/60 backdrop-blur-sm rounded-lg shadow-md">
                <div class="flex justify-between items-center text-gray-700">
                    <div>
                        <span class="font-bold text-xl">ë¬¸ì œ:</span>
                        <span id="round-counter" class="font-bold text-xl">0 / 10</span>
                    </div>
                    <div id="question-box" class="text-center">
                        <p id="question-verse" class="text-lg font-bold text-sky-800"></p>
                        <p id="question-text" class="text-xl text-gray-800 mt-1"></p>
                    </div>
                    <div>
                        <span class="font-bold text-xl">ë‚¨ì€ ì‹œê°„:</span>
                        <span id="timer" class="font-bold text-xl">03:00</span>
                    </div>
                </div>
            </div>
            <canvas id="gameCanvas"></canvas>
            <div id="scoreboard" class="mt-2 flex flex-wrap justify-center gap-2"></div>
        </div>
        
        <!-- ê²°ê³¼ í™”ë©´ -->
        <div id="result-screen" class="hidden">
            <h1 class="text-5xl font-bold text-amber-500 mb-8">ğŸ‰ ìµœì¢… ê²°ê³¼ ğŸ‰</h1>
            <div id="final-ranking" class="space-y-4 max-w-md mx-auto">
            </div>
            <button id="restart-button" class="mt-12 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition shadow-lg">ìƒˆ ê²Œì„ ì‹œì‘</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, addDoc, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCNjgy_28rzMu66Si9W4U6y6sZ6kffIPk",
            authDomain: "verse-game.firebaseapp.com",
            projectId: "verse-game",
            storageBucket: "verse-game.appspot.com",
            messagingSenderId: "84261757024",
            appId: "1:84261757024:web:9f59c6bf44ab0ebb982305"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const qrcodeContainer = document.getElementById('qrcode');
        const playerList = document.getElementById('player-list');
        const playerCountEl = document.getElementById('player-count');
        const startGameButton = document.getElementById('start-game-button');
        const gameIdDisplay = document.getElementById('game-id-display');
        const pcJoinUrlContainer = document.getElementById('pc-join-url-container');
        const pcJoinUrlInput = document.getElementById('pc-join-url');
        const copyUrlButton = document.getElementById('copy-url-button');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreboard = document.getElementById('scoreboard');
        const questionVerseEl = document.getElementById('question-verse');
        const questionTextEl = document.getElementById('question-text');
        const roundCounterEl = document.getElementById('round-counter');
        const timerEl = document.getElementById('timer');
        const finalRanking = document.getElementById('final-ranking');
        const restartButton = document.getElementById('restart-button');
        const categorySelector = document.getElementById('category-selector');
        const roundsInput = document.getElementById('rounds-input');
        const timeLimitInput = document.getElementById('time-limit-input');

        let gameId;
        let players = {};
        let playersUnsubscribe, actionsUnsubscribe;
        let versesData = [];
        let currentBlankWord;
        let enemies = [];
        let particles = [];
        let beams = [];
        let gameTimerId = null;
        let roundActive = false;
        let synth;

        let selectedCategories = [];
        let totalRounds = 10;
        let totalGameTime = 180;

        const difficultySettings = {
            speed: 0.5, 
            points: 10,
            penalty: -10
        };

        class PlayerCharacter {
            constructor(id, name) {
                this.id = id;
                this.name = name;
                this.width = 50;
                this.height = 40;
                this.x = Math.random() * (canvas.width - this.width);
                this.y = canvas.height - this.height - 10;
                const r = Math.floor(Math.random() * 155) + 100;
                const g = Math.floor(Math.random() * 155) + 100;
                const b = Math.floor(Math.random() * 155) + 100;
                this.color = `rgb(${r},${g},${b})`;
                this.flash = 0;
                
                const sheepSVG = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 45" width="${this.width}" height="${this.height}">
                      <g fill="${this.color}" stroke="#555" stroke-width="1">
                        <path d="M20,25 a10,10 0 1,1 20,0 a15,15 0 1,1 -20,0" transform="translate(0, 5)"/>
                        <circle cx="15" cy="20" r="8"/><circle cx="45" cy="20" r="8"/><circle cx="30" cy="12" r="10"/>
                        <g fill="#000"><circle cx="25" cy="30" r="1.5"/><circle cx="35" cy="30" r="1.5"/></g>
                        <path d="M 28 35 q 2 -3 4 0" stroke="black" fill="none" stroke-width="1"/>
                      </g>
                      <rect x="20" y="38" width="5" height="7" rx="2" fill="${this.color}" stroke="#555" /><rect x="35" y="38" width="5" height="7" rx="2" fill="${this.color}" stroke="#555"/>
                    </svg>`;
                this.image = new Image();
                this.image.src = `data:image/svg+xml;base64,${btoa(sheepSVG)}`;
            }
            draw() {
                if (this.flash > 0) {
                    ctx.globalAlpha = 0.5 + (Math.sin(Date.now() / 50) * 0.5);
                    this.flash--;
                }
                ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                ctx.globalAlpha = 1.0;
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.font = '14px Gowun Dodum';
                ctx.fillText(this.name, this.x + this.width / 2, this.y - 5);
            }
            shoot() {
                this.flash = 30;
                beams.push(new Beam(this.x + this.width / 2, this.y, this.color));
            }
        }
        
        class Enemy {
             constructor(x, y, word, isCorrect, number) {
                this.x = x; this.y = y;
                this.speed = (Math.random() * 0.5 + 0.8) * difficultySettings.speed;
                this.word = word; this.isCorrect = isCorrect;
                this.number = number;
                ctx.font = 'bold 24px Gowun Dodum';
                this.width = ctx.measureText(this.word).width + 40;
                this.height = 50;

                const monsterSVG = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="${this.width}" height="${this.height}">
                        <path d="M5,45 C5,20 45,20 45,45 Q40,40 35,45 C30,40 20,40 15,45 Q10,40 5,45 Z" fill="#4A5568"/>
                        <circle cx="18" cy="25" r="4" fill="white">
                            <animate attributeName="cy" values="25;22;25" dur="1s" repeatCount="indefinite" />
                        </circle>
                        <circle cx="32" cy="25" r="4" fill="white">
                            <animate attributeName="cy" values="25;22;25" dur="1s" repeatCount="indefinite" />
                        </circle>
                    </svg>`;
                this.image = new Image();
                this.image.src = `data:image/svg+xml;base64,${btoa(monsterSVG)}`;
            }
            draw() {
                ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                ctx.font = 'bold 24px Gowun Dodum';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 5;
                ctx.strokeText(this.word, this.x + this.width / 2, this.y + this.height / 2 + 2);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(this.word, this.x + this.width / 2, this.y + this.height / 2 + 2);
                
                ctx.font = 'bold 22px Arial';
                ctx.fillStyle = 'yellow';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.strokeText(this.number, this.x + this.width / 2, this.y - 10);
                ctx.fillText(this.number, this.x + this.width / 2, this.y - 10);
            }
            update() { this.y += this.speed; this.draw(); }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.radius = Math.random() * 4 + 2;
                this.speedX = Math.random() * 6 - 3;
                this.speedY = Math.random() * 6 - 3;
                this.life = 100;
                this.color = color;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${this.color}, ${this.life / 100})`;
                ctx.fill();
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                this.life -= 3;
                this.draw();
            }
        }

        class Beam {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.width = 15;
                this.life = 15; // 15 í”„ë ˆì„(ì•½ 0.25ì´ˆ) ë™ì•ˆ ì§€ì†
            }
            draw() {
                const alpha = this.life / 15;
                ctx.fillStyle = `rgba(${this.color.replace('rgb(','').replace(')','')}, ${alpha * 0.8})`;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 20;
                ctx.fillRect(this.x - this.width / 2, 0, this.width, this.y);
                ctx.shadowBlur = 0;
            }
            update() {
                this.life--;
                this.draw();
            }
        }
        
        function setupAudio() {
            if (synth || (Tone.context && Tone.context.state === 'running')) return;
            Tone.start();
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
        }
        const playSound = (logic) => { if (synth) logic(); };
        const playCorrectSound = () => playSound(() => synth.triggerAttackRelease(['C5', 'G5'], '8n'));
        const playIncorrectSound = () => playSound(() => synth.triggerAttackRelease('C3', '8n'));
        const playRoundStartSound = () => playSound(() => synth.triggerAttackRelease('C4', '8n'));
        const playFinishSound = () => playSound(() => synth.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '4n'));


        async function initializeHost() {
            const gameRef = await addDoc(collection(db, "games"), {
                state: "lobby",
                createdAt: serverTimestamp()
            });
            gameId = gameRef.id;
            gameIdDisplay.textContent = gameId;

            const joinUrl = `${window.location.origin}/join.html?gameId=${gameId}`;
            
            pcJoinUrlInput.value = joinUrl;
            pcJoinUrlContainer.classList.remove('hidden');

            const qr = qrcode(0, 'L');
            qr.addData(joinUrl);
            qr.make();
            qrcodeContainer.innerHTML = qr.createImgTag(6);

            const playersRef = collection(db, "games", gameId, "players");
            playersUnsubscribe = onSnapshot(playersRef, (snapshot) => {
                const newPlayersData = {};
                snapshot.forEach(doc => {
                    newPlayersData[doc.id] = doc.data();
                });
                updatePlayerList(newPlayersData);
                updateScoreboard(newPlayersData);
                if (Object.keys(newPlayersData).length > 0) {
                    startGameButton.disabled = false;
                }
            });
        }

        function updatePlayerList(newPlayerData) {
            playerList.innerHTML = '';
            const playerIds = Object.keys(newPlayerData);
            playerCountEl.textContent = playerIds.length;

            if (playerIds.length === 0) {
                playerList.innerHTML = '<li class="text-gray-500">ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤...</li>';
                return;
            }

            playerIds.forEach(id => {
                const playerData = newPlayerData[id];
                const li = document.createElement('li');
                li.textContent = `ğŸ‘ ${playerData.name}`;
                playerList.appendChild(li);

                if (!players[id]) {
                    players[id] = { ...playerData, character: null };
                } else {
                    players[id] = { ...players[id], ...playerData };
                }
            });
            Object.keys(players).forEach(id => {
                if (!newPlayerData[id]) {
                    delete players[id];
                }
            });
        }

        function updateScoreboard(playerData) {
            scoreboard.innerHTML = '';
            const sortedPlayers = Object.entries(playerData).sort((a, b) => b[1].score - a[1].score);
            
            for (const [id, data] of sortedPlayers) {
                const div = document.createElement('div');
                div.className = 'p-2 bg-white/80 rounded-md shadow';
                div.innerHTML = `<div class="font-bold text-lg">${data.name}</div><div class="text-xl">${data.score}ì </div>`;
                scoreboard.appendChild(div);
            }
        }
        
        function listenForActions() {
            const actionsRef = collection(db, "games", gameId, "actions");
            actionsUnsubscribe = onSnapshot(actionsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const action = change.doc.data();
                        handlePlayerAction(action.playerId, action.payload);
                    }
                });
            });
        }

        async function handlePlayerAction(playerId, payload) {
            if (!roundActive) return;

            const targetNumber = parseInt(payload.target, 10);
            const targetEnemy = enemies.find(e => e.number === targetNumber);

            if (targetEnemy) {
                const player = players[playerId];
                if (player && player.character) {
                    player.character.x = targetEnemy.x + (targetEnemy.width / 2) - (player.character.width / 2);
                    player.character.shoot();
                }

                if (targetEnemy.isCorrect) {
                    roundActive = false;
                    playCorrectSound();
                    
                    const newScore = (player.score || 0) + difficultySettings.points;
                    await updateDoc(doc(db, "games", gameId, "players", playerId), { score: newScore });

                    for(let i = 0; i < 30; i++) {
                        particles.push(new Particle(targetEnemy.x + targetEnemy.width/2, targetEnemy.y + targetEnemy.height/2, '255, 215, 0'));
                    }
                    
                    setTimeout(() => { nextRound(); }, 2000);

                } else {
                    playIncorrectSound();
                    const playerDocRef = doc(db, "games", gameId, "players", playerId);
                    const currentScore = player.score || 0;
                    await updateDoc(playerDocRef, { score: Math.max(0, currentScore + difficultySettings.penalty) });
                }
            }
        }

        async function startGame() {
            selectedCategories = [...categorySelector.querySelectorAll('.selected')].map(btn => btn.dataset.category);
            totalRounds = parseInt(roundsInput.value) || 10;
            totalGameTime = (parseInt(timeLimitInput.value) || 3) * 60;

            if (selectedCategories.length === 0) {
                alert('í•˜ë‚˜ ì´ìƒì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            setupAudio();
            listenForActions();
            
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            canvas.width = document.getElementById('game-container').clientWidth;
            canvas.height = Math.min(window.innerHeight * 0.6, 600);
            
            Object.keys(players).forEach(id => {
                players[id].character = new PlayerCharacter(id, players[id].name);
            });

            await updateDoc(doc(db, "games", gameId), { 
                state: "playing",
                settings: {
                    categories: selectedCategories,
                    rounds: totalRounds,
                    time: totalGameTime
                }
            });
            
            let currentRound = 0;
            nextRound(currentRound);
            startTotalGameTimer();
            animate();
        }
        
        let currentRound = 0;
        async function nextRound() {
            if (currentRound >= totalRounds) {
                endGame();
                return;
            }
            currentRound++;
            roundActive = true;
            playRoundStartSound();

            enemies = [];
            particles = [];
            beams = [];
            roundCounterEl.textContent = `${currentRound} / ${totalRounds}`;
            
            let filteredVerses = versesData;
            if (!selectedCategories.includes('ì „ì²´')) {
                filteredVerses = versesData.filter(v => v.ì¹´í…Œê³ ë¦¬ && selectedCategories.includes(v.ì¹´í…Œê³ ë¦¬));
            }
            if (filteredVerses.length === 0) {
                alert('ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ëŠ” ë§ì”€ êµ¬ì ˆì´ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.');
                endGame();
                return;
            }

            let verse, words, blankIndex;
            do {
                verse = filteredVerses[Math.floor(Math.random() * filteredVerses.length)];
                words = verse.ë³¸ë¬¸.split(' ').filter(w => w.trim().length > 0);
            } while (words.length < 3);

            blankIndex = Math.floor(Math.random() * words.length);
            currentBlankWord = words[blankIndex];
            
            const distractors = [];
            const allWords = versesData.flatMap(v => v.ë³¸ë¬¸.split(' ')).filter(w => w.trim().length > 1 && w !== currentBlankWord);
            while (distractors.length < 2) {
                const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                if (randomWord && !distractors.includes(randomWord)) distractors.push(randomWord);
            }

            const options = [currentBlankWord, ...distractors];
            options.sort(() => Math.random() - 0.5);

            options.forEach((word, i) => {
                const x = (canvas.width / (options.length + 1)) * (i + 1) - 50;
                enemies.push(new Enemy(x, -60, word, word === currentBlankWord, i + 1));
            });

            const questionPayload = {
                verse: `[${verse.ì¥ì ˆ}]`,
                text: words.map((w, i) => (i === blankIndex ? '_______' : w)).join(' '),
            };

            questionVerseEl.textContent = questionPayload.verse;
            questionTextEl.textContent = questionPayload.text;

            await updateDoc(doc(db, "games", gameId), {
                currentRound,
                question: questionPayload,
            });
        }
        
        function startTotalGameTimer() {
            let timeLeft = totalGameTime;
            gameTimerId = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function animate() {
            if (gameScreen.classList.contains('hidden')) return;
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (const id in players) {
                if(players[id].character) players[id].character.draw();
            }
            
            enemies.forEach((e, i) => {
                if (e.y > canvas.height) {
                    enemies.splice(i, 1);
                } else {
                    e.update();
                }
            });

            if (roundActive && enemies.length === 0) {
                roundActive = false;
                setTimeout(() => nextRound(), 1500);
            }

            beams.forEach((b, i) => {
                if (b.life <= 0) {
                    beams.splice(i, 1);
                } else {
                    b.update();
                }
            });
            particles.forEach((p, i) => {
                if (p.life <= 0) particles.splice(i, 1);
                else p.update();
            });
        }

        async function endGame() {
            if (gameScreen.classList.contains('hidden')) return; // ì´ë¯¸ ì¢…ë£Œëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            
            clearInterval(gameTimerId);
            playFinishSound();
            if (actionsUnsubscribe) actionsUnsubscribe();
            
            gameScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            await updateDoc(doc(db, "games", gameId), { state: "finished" });

            const sortedPlayers = Object.values(players).sort((a,b) => b.score - a.score);
            finalRanking.innerHTML = '';
            sortedPlayers.forEach((p, index) => {
                const div = document.createElement('div');
                const rankEmoji = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] || `${index + 1}ìœ„`;
                div.className = 'p-4 bg-white rounded-lg shadow-md flex justify-between items-center text-2xl';
                div.innerHTML = `
                    <span class="font-bold">${rankEmoji} ${p.name}</span>
                    <span>${p.score}ì </span>
                `;
                finalRanking.appendChild(div);
            });
        }

        startGameButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', () => window.location.reload());
        
        copyUrlButton.addEventListener('click', () => {
            pcJoinUrlInput.select();
            document.execCommand('copy');
            copyUrlButton.textContent = 'ë³µì‚¬ë¨!';
            setTimeout(() => {
                copyUrlButton.textContent = 'ë³µì‚¬';
            }, 1500);
        });

        async function loadDataAndInit() {
            try {
                const response = await fetch('verses.json');
                if (!response.ok) throw new Error('verses.jsonì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                versesData = await response.json();
                
                const categories = ['ì „ì²´', ...new Set(versesData.map(v => v.ì¹´í…Œê³ ë¦¬).filter(Boolean))];
                categorySelector.innerHTML = '';
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.textContent = cat;
                    btn.dataset.category = cat;
                    btn.className = 'category-btn p-2 border rounded-md bg-white hover:bg-sky-200 transition';
                    if (cat === 'ì „ì²´') {
                        btn.classList.add('selected');
                    }
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('selected');
                        if (btn.dataset.category === 'ì „ì²´' && btn.classList.contains('selected')) {
                            categorySelector.querySelectorAll('.category-btn').forEach(b => {
                                if (b !== btn) b.classList.remove('selected');
                            });
                        } else if (btn.dataset.category !== 'ì „ì²´' && btn.classList.contains('selected')) {
                             categorySelector.querySelector('[data-category="ì „ì²´"]').classList.remove('selected');
                        }
                    });
                    categorySelector.appendChild(btn);
                });

                await initializeHost();
            } catch (error) {
                console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                alert("ê²Œì„ì„ ì´ˆê¸°í™”í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
            }
        }

        loadDataAndInit();
    </script>
</body>
</html>
