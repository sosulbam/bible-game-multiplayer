<!-- ======================================================================= -->
<!-- =======================   index.html (진행자 화면)   ======================= -->
<!-- ======================================================================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>말씀의 빛: 그룹 대전 (진행자 화면)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Gowun Dodum', sans-serif; background-color: #f0f9ff; }
        .game-canvas { background: linear-gradient(to bottom, #38bdf8, #e0f2fe); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .category-btn.selected, .mode-btn.selected, .gameplay-btn.selected, .assign-btn.selected, .theme-btn.selected { background-color: #0ea5e9; color: white; }
        .player-item { cursor: pointer; transition: background-color 0.2s; }
        .player-item:hover { background-color: #dbeafe; }
        
        /* 두더지 게임 스타일 */
        #mole-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; max-width: 600px; margin: 0 auto; aspect-ratio: 1 / 1; }
        .mole-hole { background-color: #a16f5a; border-radius: 50%; border-bottom: 10px solid #78523f; position: relative; overflow: hidden; }
        .mole-hole::before { content: ''; position: absolute; top: 20%; left: 50%; transform: translateX(-50%); width: 80%; height: 40%; background: #5c3d2e; border-radius: 50%; }
        .mole { position: absolute; bottom: -100%; left: 50%; transform: translateX(-50%); width: 70%; transition: bottom 0.2s ease-out; cursor: pointer; }
        .mole.up { bottom: 10%; }
        .mole img { width: 100%; display: block; }
        .mole .word-plate { position: absolute; bottom: 90%; left: 50%; transform: translateX(-50%); background: #fff; border: 3px solid #663300; border-radius: 8px; padding: 2px 8px; font-size: 1.2rem; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .hit-effect { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; opacity: 0; animation: fade-out 0.5s; }
        @keyframes fade-out { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0; transform: translate(-50%, -70%) scale(1.2); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="game-container" class="w-full max-w-5xl mx-auto p-4 text-center">
        <!-- 대기 화면 -->
        <div id="lobby-screen">
            <h1 class="text-4xl font-bold text-sky-700 mb-4">말씀의 빛: 그룹 대전</h1>
            <p class="text-xl text-gray-600 mb-6">스마트폰으로 QR 코드를 스캔하여 게임에 참여하세요!</p>
            
            <div class="max-w-4xl mx-auto bg-white/70 p-4 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-bold text-gray-700 mb-3">게임 설정</h3>
                
                <!-- 게임 방식 선택 -->
                <div class="mb-4">
                    <label class="font-bold">게임 방식:</label>
                    <div id="gameplay-mode-selector" class="inline-flex rounded-md shadow-sm" role="group">
                      <button type="button" data-gameplay="fill-in-blank" class="gameplay-btn selected py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-l-lg border border-gray-200 hover:bg-gray-100">말씀 채우기</button>
                      <button type="button" data-gameplay="mole-whack" class="gameplay-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-r-md border border-gray-200 hover:bg-gray-100">두더지 잡기</button>
                    </div>
                </div>

                <div class="mb-4 flex justify-center items-center gap-6">
                    <div>
                        <label class="font-bold">게임 모드:</label>
                        <div id="game-mode-selector" class="inline-flex rounded-md shadow-sm" role="group">
                          <button type="button" data-mode="personal" class="mode-btn selected py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-l-lg border border-gray-200 hover:bg-gray-100">개인전</button>
                          <button type="button" data-mode="team" class="mode-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-r-md border border-gray-200 hover:bg-gray-100">팀전</button>
                        </div>
                    </div>
                    <div id="team-settings-container" class="hidden flex items-center gap-6">
                        <div>
                            <label class="font-bold">팀 이름 테마:</label>
                            <div id="team-theme-selector" class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" data-theme="animals" class="theme-btn selected py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-l-lg border border-gray-200 hover:bg-gray-100">동물</button>
                                <button type="button" data-theme="bible" class="theme-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-r-md border border-gray-200 hover:bg-gray-100">성경 인물</button>
                            </div>
                        </div>
                        <div>
                            <label class="font-bold">팀 배정 방식:</label>
                            <div id="team-assign-selector" class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" data-assign="auto" class="assign-btn selected py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-l-lg border border-gray-200 hover:bg-gray-100">자동 배정</button>
                                <button type="button" data-assign="choice" class="assign-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white rounded-r-md border border-gray-200 hover:bg-gray-100">참가자 선택</button>
                            </div>
                        </div>
                        <button id="reshuffle-btn" class="py-2 px-4 text-sm font-medium text-white bg-green-500 rounded-lg hover:bg-green-600">팀 재분배</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div>
                        <label class="font-bold">카테고리 선택 (다중 선택 가능):</label>
                        <div id="category-selector" class="mt-2 flex flex-wrap gap-2 p-2 bg-gray-100 rounded-md max-h-64 overflow-y-auto"></div>
                    </div>
                    <div class="space-y-3">
                        <div id="fill-in-blank-settings">
                            <div>
                                <label for="rounds-input" class="font-bold">문제 수:</label>
                                <input type="number" id="rounds-input" value="10" min="5" max="50" step="1" class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="time-limit-input" class="font-bold">총 게임 시간 (분):</label>
                                <input type="number" id="time-limit-input" value="1" min="1" max="10" step="1" class="w-full p-2 border rounded-md">
                            </div>
                        </div>
                        <div id="mole-whack-settings" class="hidden">
                             <div>
                                <label for="mole-rounds-input" class="font-bold">문제 수:</label>
                                <input type="number" id="mole-rounds-input" value="10" min="5" max="50" step="1" class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="mole-speed-input" class="font-bold">두더지 출현 속도 (초):</label>
                                <input type="number" id="mole-speed-input" value="1.5" min="0.5" max="5" step="0.1" class="w-full p-2 border rounded-md">
                            </div>
                             <div>
                                <label for="mole-time-limit-input" class="font-bold">라운드 제한 시간 (초):</label>
                                <input type="number" id="mole-time-limit-input" value="10" min="5" max="30" step="1" class="w-full p-2 border rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center gap-8">
                <div id="qrcode" class="p-4 bg-white rounded-lg shadow-md"></div>
                <div id="player-list-container" class="w-full max-w-md">
                    <h2 class="text-2xl font-bold mb-3">참가자 목록 (<span id="player-count">0</span>명)</h2>
                    <ul id="player-list" class="text-left text-lg space-y-1 h-48 overflow-y-auto p-2 bg-gray-100 rounded-lg">
                        <li class="text-gray-500 p-2">아직 참가자가 없습니다...</li>
                    </ul>
                </div>
                <div id="team-display" class="hidden w-full max-w-md grid-cols-2 gap-4">
                    <div>
                        <h2 id="team-a-name" class="text-2xl font-bold mb-3 text-blue-600"></h2>
                        <ul id="team-a-list" class="text-left text-lg space-y-1 h-48 overflow-y-auto p-2 bg-blue-50 rounded-lg"></ul>
                    </div>
                    <div>
                        <h2 id="team-b-name" class="text-2xl font-bold mb-3 text-red-600"></h2>
                        <ul id="team-b-list" class="text-left text-lg space-y-1 h-48 overflow-y-auto p-2 bg-red-50 rounded-lg"></ul>
                    </div>
                </div>
            </div>
            <div class="mt-8">
                <button id="start-game-button" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>게임 시작</button>
            </div>
            <div class="mt-4 space-y-2">
                 <p class="text-gray-500">게임 ID: <span id="game-id-display"></span></p>
                 <div id="pc-join-url-container" class="mt-2 hidden">
                    <p class="text-gray-600">PC 참가자용 주소:</p>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <input type="text" id="pc-join-url" class="w-full max-w-md p-2 border rounded-md bg-gray-100 text-center" readonly>
                        <button id="copy-url-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md transition">복사</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 게임 화면 -->
        <div id="game-screen" class="hidden">
            <div id="game-ui" class="mb-4 p-3 bg-white/80 backdrop-blur-sm rounded-xl shadow-lg flex justify-between items-center gap-6">
                <div class="flex-none flex items-center divide-x divide-gray-300">
                    <div class="px-4 text-center">
                        <div class="text-sm text-gray-600">문제</div>
                        <div id="round-counter" class="font-bold text-2xl text-sky-700">1 / 10</div>
                    </div>
                    <div class="px-4 text-center">
                        <div class="text-sm text-gray-600">남은 시간</div>
                        <div id="timer" class="font-bold text-2xl text-red-500">01:00</div>
                    </div>
                </div>
                <div id="question-box" class="flex-grow text-center">
                    <p id="question-verse" class="text-lg font-bold text-sky-800"></p>
                    <p id="question-text" class="text-2xl text-gray-900 mt-1"></p>
                </div>
                <div class="flex-none flex items-center gap-2">
                    <button id="sound-toggle-btn" class="p-2 rounded-full hover:bg-gray-200 transition">
                        <svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        <svg id="sound-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l-2-2m0 0l-2-2m2 2l2 2m-2-2l2-2" />
                        </svg>
                    </button>
                    <button id="pause-game-btn" class="py-2 px-4 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600">일시정지</button>
                    <button id="force-end-game-btn" class="py-2 px-4 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600">즉시 종료</button>
                </div>
            </div>
            
            <canvas id="fill-in-blank-canvas" class="game-canvas"></canvas>
            <div id="mole-whack-canvas" class="hidden">
                 <div id="mole-grid"></div>
            </div>

            <div id="scoreboard" class="mt-2 flex flex-wrap justify-center gap-4"></div>
        </div>
        
        <!-- 결과 화면 -->
        <div id="result-screen" class="hidden">
            <h1 id="result-title" class="text-5xl font-bold text-amber-500 mb-8">🎉 최종 결과 🎉</h1>
            <div id="final-ranking" class="space-y-4 max-w-md mx-auto">
            </div>
            <button id="restart-button" class="mt-12 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition shadow-lg">새 게임 시작</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, updateDoc, addDoc, query, serverTimestamp, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCNjgy_28rzMu66Si9W4U6y6sZ6kffIPk",
            authDomain: "verse-game.firebaseapp.com",
            projectId: "verse-game",
            storageBucket: "verse-game.appspot.com",
            messagingSenderId: "84261757024",
            appId: "1:84261757024:web:9f59c6bf44ab0ebb982305"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const qrcodeContainer = document.getElementById('qrcode');
        const playerCountEl = document.getElementById('player-count');
        const startGameButton = document.getElementById('start-game-button');
        const gameIdDisplay = document.getElementById('game-id-display');
        const pcJoinUrlContainer = document.getElementById('pc-join-url-container');
        const pcJoinUrlInput = document.getElementById('pc-join-url');
        const copyUrlButton = document.getElementById('copy-url-button');
        const scoreboard = document.getElementById('scoreboard');
        const questionVerseEl = document.getElementById('question-verse');
        const questionTextEl = document.getElementById('question-text');
        const roundCounterEl = document.getElementById('round-counter');
        const timerEl = document.getElementById('timer');
        const finalRanking = document.getElementById('final-ranking');
        const resultTitle = document.getElementById('result-title');
        const restartButton = document.getElementById('restart-button');
        const categorySelector = document.getElementById('category-selector');
        
        // Player & Team Lists
        const playerListContainer = document.getElementById('player-list-container');
        const playerList = document.getElementById('player-list');
        const teamDisplay = document.getElementById('team-display');
        const teamANameEl = document.getElementById('team-a-name');
        const teamBNameEl = document.getElementById('team-b-name');
        const teamAListEl = document.getElementById('team-a-list');
        const teamBListEl = document.getElementById('team-b-list');
        
        // Settings Elements
        const gameplayModeSelector = document.getElementById('gameplay-mode-selector');
        const fillInBlankSettings = document.getElementById('fill-in-blank-settings');
        const moleWhackSettings = document.getElementById('mole-whack-settings');
        const roundsInput = document.getElementById('rounds-input');
        const timeLimitInput = document.getElementById('time-limit-input');
        const moleRoundsInput = document.getElementById('mole-rounds-input');
        const moleSpeedInput = document.getElementById('mole-speed-input');
        const moleTimeLimitInput = document.getElementById('mole-time-limit-input');
        
        const gameModeSelector = document.getElementById('game-mode-selector');
        const teamSettingsContainer = document.getElementById('team-settings-container');
        const teamThemeSelector = document.getElementById('team-theme-selector');
        const teamAssignSelector = document.getElementById('team-assign-selector');
        
        // Buttons
        const reshuffleBtn = document.getElementById('reshuffle-btn');
        const pauseGameBtn = document.getElementById('pause-game-btn');
        const forceEndGameBtn = document.getElementById('force-end-game-btn');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const soundOnIcon = document.getElementById('sound-on-icon');
        const soundOffIcon = document.getElementById('sound-off-icon');

        // Canvases
        const fillInBlankCanvas = document.getElementById('fill-in-blank-canvas');
        const ctx = fillInBlankCanvas.getContext('2d');
        const moleWhackCanvas = document.getElementById('mole-whack-canvas');
        const moleGrid = document.getElementById('mole-grid');

        // --- State Variables ---
        let gameId;
        let gameplayMode = 'fill-in-blank'; // 'fill-in-blank' or 'mole-whack'
        let players = {};
        let teams = {};
        let gameMode = 'personal';
        let assignMode = 'auto';
        let teamTheme = 'animals';
        let playersUnsubscribe, actionsUnsubscribe;
        let versesData = [];
        let currentBlankWord;
        let enemies = [];
        let particles = [];
        let beams = [];
        let gameTimerId = null;
        let roundTimerId = null;
        let roundActive = false;
        let isGamePaused = false;
        let synth;
        let isSoundEnabled = true;

        let selectedCategories = [];
        let totalRounds = 10;
        let totalGameTime = 60;
        
        // Mole Game State
        let moles = [];
        let moleGameInterval = null;
        let currentMoleSpeed = 1.5;

        // --- Constants ---
        const difficultySettings = {
            speed: 0.5, 
            points: 10,
            penalty: -5
        };

        const teamNameThemes = {
            animals: ["🦁 사자", "🐯 호랑이", "🐻 곰", "🦊 여우", "🦅 독수리", "🦄 유니콘", "🐉 용", "🐘 코끼리", "🐬 돌고래", "🦈 상어"],
            bible: ["🔑 베드로", "📜 야고보", "🕊️ 요한", "⚔️ 바울", "🌴 드보라", "🙏 한나", "⚕️ 모세", "⭐ 아브라함", "💖 마리아", "👑 다윗", "🐑 라헬", "🏺 리브가", "🌾 룻"]
        };
        
        // --- Classes for Fill-in-Blank Game ---
        class PlayerCharacter { /* ... (same as before) ... */ }
        class Enemy { /* ... (same as before) ... */ }
        class Particle { /* ... (same as before) ... */ }
        class Beam { /* ... (same as before) ... */ }
        
        // --- Audio Functions ---
        function setupAudio() {
            if (synth || (Tone.context && Tone.context.state === 'running')) return;
            try {
                Tone.start();
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
            } catch (e) {
                console.warn("Could not start audio context.", e);
            }
        }
        
        const playSound = (logic) => {
            if (synth && isSoundEnabled) logic();
        };

        const playCorrectSound = () => playSound(() => synth.triggerAttackRelease(['C5', 'G5'], '8n'));
        const playIncorrectSound = () => playSound(() => synth.triggerAttackRelease('C3', '8n'));
        const playRoundStartSound = () => playSound(() => synth.triggerAttackRelease('C4', '8n'));
        const playFinishSound = () => playSound(() => synth.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '4n'));
        const playWhackSound = () => playSound(() => synth.triggerAttackRelease('E3', '16n'));
        
        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            soundOnIcon.classList.toggle('hidden', !isSoundEnabled);
            soundOffIcon.classList.toggle('hidden', isSoundEnabled);
        }

        // --- Core Game Logic ---
        async function initializeHost() {
            // ... (same as before, no changes needed here)
        }

        function updatePlayerListUI() { /* ... (same as before) ... */ }
        function updateScoreboard(playerData) { /* ... (same as before) ... */ }
        function updateTeamScoreboard() { /* ... (same as before) ... */ }
        
        function listenForActions() {
            const actionsRef = collection(db, "games", gameId, "actions");
            actionsUnsubscribe = onSnapshot(actionsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && change.doc.data().timestamp) {
                        const action = change.doc.data();
                        if (gameplayMode === 'fill-in-blank') {
                            handlePlayerAction(action.playerId, action.payload);
                        } else if (gameplayMode === 'mole-whack') {
                            handleMoleWhackAction(action.playerId, action.payload);
                        }
                    }
                });
            });
        }

        async function handlePlayerAction(playerId, payload) { /* ... (same as before) ... */ }
        
        async function handleMoleWhackAction(playerId, payload) {
            if (!roundActive || isGamePaused) return;
            
            const holeIndex = payload.holeIndex;
            const mole = moles[holeIndex];
            
            if (!mole || !mole.isUp) return; // Mole not present or already hit

            playWhackSound();
            
            // Show hit effect on host screen
            const holeElement = document.getElementById(`mole-hole-${holeIndex}`);
            const effect = document.createElement('div');
            effect.className = 'hit-effect';
            
            if (mole.isCorrect) {
                effect.textContent = '⭐';
            } else {
                effect.textContent = '💨';
            }
            holeElement.appendChild(effect);
            setTimeout(() => effect.remove(), 500);

            mole.hide(); // Hide the mole immediately after whacking

            try {
                await runTransaction(db, async (transaction) => {
                    const playerDocRef = doc(db, "games", gameId, "players", playerId);
                    const gameDocRef = doc(db, "games", gameId);
                    const playerDoc = await transaction.get(playerDocRef);
                    const gameDoc = await transaction.get(gameDocRef);

                    if (!playerDoc.exists() || !gameDoc.exists() || !roundActive) return;

                    const currentScore = playerDoc.data().score || 0;
                    const currentTeam = playerDoc.data().team;
                    const currentTeams = gameDoc.data().teams;

                    if (mole.isCorrect) {
                        roundActive = false;
                        playCorrectSound();
                        
                        transaction.update(playerDocRef, { score: currentScore + difficultySettings.points });
                        if (gameMode === 'team' && currentTeam) {
                            const newTeamScore = (currentTeams[currentTeam].score || 0) + difficultySettings.points;
                            transaction.update(gameDocRef, { [`teams.${currentTeam}.score`]: newTeamScore });
                        }
                        
                        // Stop timers and move to next round
                        clearInterval(moleGameInterval);
                        clearInterval(roundTimerId);
                        setTimeout(() => nextRound(), 2000);

                    } else { // Incorrect whack
                        playIncorrectSound();
                        transaction.update(playerDocRef, { score: currentScore + difficultySettings.penalty });
                        if (gameMode === 'team' && currentTeam) {
                            const newTeamScore = (currentTeams[currentTeam].score || 0) + difficultySettings.penalty;
                            transaction.update(gameDocRef, { [`teams.${currentTeam}.score`]: newTeamScore });
                        }
                    }
                });
            } catch (e) {
                console.error("Mole Whack Transaction failed: ", e);
            }
        }

        async function startGame() {
            selectedCategories = [...categorySelector.querySelectorAll('.selected')].map(btn => btn.dataset.category);
            if (selectedCategories.length === 0) {
                alert('하나 이상의 카테고리를 선택해주세요.');
                return;
            }

            setupAudio();
            listenForActions();
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            let settings;
            if (gameplayMode === 'fill-in-blank') {
                totalRounds = parseInt(roundsInput.value) || 10;
                totalGameTime = (parseInt(timeLimitInput.value) || 1) * 60;
                fillInBlankCanvas.classList.remove('hidden');
                moleWhackCanvas.classList.add('hidden');
                fillInBlankCanvas.width = document.getElementById('game-container').clientWidth;
                fillInBlankCanvas.height = Math.min(window.innerHeight * 0.7, 700);
                Object.keys(players).forEach(id => {
                    players[id].character = new PlayerCharacter(id, players[id].name, players[id].team);
                });
                startTotalGameTimer();
                animate();
                settings = { categories: selectedCategories, rounds: totalRounds, time: totalGameTime, gameplayMode };
            } else { // mole-whack
                totalRounds = parseInt(moleRoundsInput.value) || 10;
                currentMoleSpeed = parseFloat(moleSpeedInput.value) || 1.5;
                fillInBlankCanvas.classList.add('hidden');
                moleWhackCanvas.classList.remove('hidden');
                createMoleGrid();
                settings = { categories: selectedCategories, rounds: totalRounds, moleSpeed: currentMoleSpeed, gameplayMode };
            }

            await updateDoc(doc(db, "games", gameId), { 
                state: "playing",
                settings: settings
            });
            
            nextRound();
        }
        
        let currentRound = 0;
        async function nextRound() {
            if (currentRound >= totalRounds) {
                endGame();
                return;
            }
            currentRound++;
            roundCounterEl.textContent = `${currentRound} / ${totalRounds}`;
            playRoundStartSound();
            
            if (gameplayMode === 'fill-in-blank') {
                await nextRoundFillInBlank();
            } else {
                await nextRoundMoleWhack();
            }
        }

        async function nextRoundFillInBlank() { /* ... (same as original nextRound) ... */ }
        
        async function nextRoundMoleWhack() {
            roundActive = true;
            
            // Difficulty scaling
            const baseSpeed = parseFloat(moleSpeedInput.value) || 1.5;
            currentMoleSpeed = Math.max(0.5, baseSpeed - (currentRound * 0.05));

            let filteredVerses = versesData;
            if (!selectedCategories.includes('전체')) {
                filteredVerses = versesData.filter(v => v.카테고리 && selectedCategories.includes(v.카테고리));
            }
            if (filteredVerses.length === 0) {
                alert('선택한 카테고리에 해당하는 말씀 구절이 없습니다. 게임을 종료합니다.');
                endGame();
                return;
            }
            
            const verse = filteredVerses[Math.floor(Math.random() * filteredVerses.length)];
            const firstWord = verse.본문.split(' ')[0].replace(/[.,!?]/g, '');

            const allFirstWords = Array.from(new Set(versesData.map(v => v.본문.split(' ')[0].replace(/[.,!?]/g, ''))));
            const distractors = [];
            while(distractors.length < 8) { // Get enough for all holes
                const randomWord = allFirstWords[Math.floor(Math.random() * allFirstWords.length)];
                if (randomWord !== firstWord && !distractors.includes(randomWord)) {
                    distractors.push(randomWord);
                }
            }

            // Prepare moles for all 9 holes
            moles.forEach(mole => mole.reset());
            const wordsForRound = [firstWord, ...distractors.slice(0, 8)];
            wordsForRound.sort(() => Math.random() - 0.5);

            moles.forEach((mole, index) => {
                mole.word = wordsForRound[index];
                mole.isCorrect = (mole.word === firstWord);
            });

            const questionPayload = {
                verse: `[${verse.장절}]`,
                text: '첫 어절을 잡으세요!',
            };
            questionVerseEl.textContent = questionPayload.verse;
            questionTextEl.textContent = questionPayload.text;
            
            await updateDoc(doc(db, "games", gameId), {
                currentRound,
                question: questionPayload,
            });

            startMoleGameLoop();
            startRoundTimer();
        }

        function startRoundTimer() {
            let timeLeft = parseInt(moleTimeLimitInput.value);
            timerEl.textContent = String(timeLeft).padStart(2, '0');
            roundTimerId = setInterval(() => {
                if (isGamePaused) return;
                timeLeft--;
                timerEl.textContent = String(timeLeft).padStart(2, '0');
                if (timeLeft <= 0) {
                    clearInterval(roundTimerId);
                    clearInterval(moleGameInterval);
                    roundActive = false;
                    setTimeout(() => nextRound(), 2000); // Move to next round after a delay
                }
            }, 1000);
        }

        function startMoleGameLoop() {
            moleGameInterval = setInterval(() => {
                if (!roundActive || isGamePaused) return;

                const availableMoles = moles.filter(m => !m.isUp);
                if (availableMoles.length === 0) return;

                // Pop up to 3 moles
                const molesToPop = Math.min(3, availableMoles.length);
                for (let i = 0; i < molesToPop; i++) {
                    const moleIndex = Math.floor(Math.random() * availableMoles.length);
                    const mole = availableMoles.splice(moleIndex, 1)[0];
                    if (mole) {
                        mole.pop();
                    }
                }
            }, 1000); // Interval to decide when to pop new moles
        }

        function createMoleGrid() {
            moleGrid.innerHTML = '';
            moles = [];
            for (let i = 0; i < 9; i++) {
                const hole = document.createElement('div');
                hole.id = `mole-hole-${i}`;
                hole.className = 'mole-hole';
                
                const moleEl = document.createElement('div');
                moleEl.className = 'mole';
                moleEl.innerHTML = `<div class="word-plate"></div><img src="https://i.imgur.com/C10nU6V.png" alt="두더지">`;
                hole.appendChild(moleEl);
                moleGrid.appendChild(hole);

                moles.push({
                    element: moleEl,
                    word: '',
                    isCorrect: false,
                    isUp: false,
                    timeoutId: null,
                    pop() {
                        if (this.isUp) return;
                        this.isUp = true;
                        this.element.querySelector('.word-plate').textContent = this.word;
                        this.element.classList.add('up');
                        this.timeoutId = setTimeout(() => this.hide(), currentMoleSpeed * 1000);
                    },
                    hide() {
                        this.isUp = false;
                        this.element.classList.remove('up');
                    },
                    reset() {
                        this.hide();
                        clearTimeout(this.timeoutId);
                        this.word = '';
                        this.isCorrect = false;
                    }
                });
            }
        }
        
        function startTotalGameTimer() { /* ... (same as before) ... */ }

        function animate() {
            if (gameplayMode !== 'fill-in-blank' || gameScreen.classList.contains('hidden')) return;
            requestAnimationFrame(animate);
            // ... (rest of the animate function for fill-in-blank)
        }

        async function endGame() {
            if (gameScreen.classList.contains('hidden')) return;
            roundActive = false;
            clearInterval(gameTimerId);
            clearInterval(roundTimerId);
            clearInterval(moleGameInterval);
            // ... (rest of the endGame function is the same)
        }

        function isValidBlankWord(word) { /* ... (same as before) ... */ }
        function generateDistractors(correctWord, allVerses) { /* ... (same as before) ... */ }

        // --- Event Listeners ---
        gameplayModeSelector.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            gameplayMode = e.target.dataset.gameplay;
            gameplayModeSelector.querySelectorAll('.gameplay-btn').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');

            fillInBlankSettings.classList.toggle('hidden', gameplayMode !== 'fill-in-blank');
            moleWhackSettings.classList.toggle('hidden', gameplayMode !== 'mole-whack');
        });

        gameModeSelector.addEventListener('click', async (e) => { /* ... (same as before) ... */ });
        teamThemeSelector.addEventListener('click', async (e) => { /* ... (same as before) ... */ });
        teamAssignSelector.addEventListener('click', async (e) => { /* ... (same as before) ... */ });
        reshuffleBtn.addEventListener('click', async () => { /* ... (same as before) ... */ });
        pauseGameBtn.addEventListener('click', () => { /* ... (same as before) ... */ });
        forceEndGameBtn.addEventListener('click', endGame);
        startGameButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', () => window.location.reload());
        copyUrlButton.addEventListener('click', () => { /* ... (same as before) ... */ });
        soundToggleBtn.addEventListener('click', toggleSound);

        async function loadDataAndInit() { /* ... (same as before) ... */ }

        loadDataAndInit();
    </script>
</body>
</html>